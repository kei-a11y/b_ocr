<!-- B_ocr/templates/B_ocr/upload.html -->
{% extends 'B_ocr/base.html' %}
{% load static %}

{% block title %}PDFアップロード - PDF→Excel変換サービス{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-file-earmark-pdf"></i> PDFファイル変換</h4>
            </div>
            <div class="card-body">
                {% if conversion_complete %}
                    <!-- 変換完了画面 -->
                    <div class="success-section text-center">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> 変換が完了しました！
                        </div>
                        
                        <div class="mb-4">
                            <i class="bi bi-download" style="font-size: 3rem; color: #28a745;"></i>
                            <h5 class="mt-3">Excelファイル（ZIP形式）をダウンロード</h5>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-2">
                                {% if excel_filename %}
                                <a href="{% url 'B_ocr:download' excel_filename %}" class="btn btn-success btn-lg w-100">
                                    <i class="bi bi-download"></i> ZIPをダウンロード
                                </a>
                                {% else %}
                                <div class="alert alert-warning">
                                    ダウンロードファイルが見つかりません
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-2">
                                <a href="{% url 'B_ocr:upload' %}" class="btn btn-primary btn-lg w-100">
                                    <i class="bi bi-plus-circle"></i> 新しいファイル
                                </a>
                            </div>
                        </div>
                    </div>

                {% elif processing %}
                    <!-- 処理中表示 -->
                    <div class="processing-section text-center">
                        <div class="mb-4">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">変換中...</span>
                            </div>
                        </div>
                        
                        <h5 class="mb-3">変換処理中です...</h5>
                        
                        <div class="progress-info">
                            <div class="alert alert-info">
                                <div id="progressText">
                                    <strong><span id="currentPage">0</span>件／<span id="totalPages">{{ total_pages|default:1 }}</span>件　処理中</strong>
                                </div>
                                <div id="statusMessage" class="mt-2 text-muted">
                                    処理を開始しています...
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-muted">しばらくお待ちください</p>
                        
                        <!-- 完了後の自動リダイレクト表示用（非表示） -->
                        <div id="completedSection" style="display: none;">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> 変換が完了しました！
                            </div>
                            <p>ダウンロードページに移動します...</p>
                        </div>
                        
                        <!-- エラー表示用（非表示） -->
                        <div id="errorSection" style="display: none;">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> <span id="errorMessage">エラーが発生しました</span>
                            </div>
                            <a href="{% url 'B_ocr:upload' %}" class="btn btn-primary">
                                <i class="bi bi-arrow-left"></i> 戻る
                            </a>
                        </div>
                    </div>

                {% else %}
                    <!-- アップロード・変換フォーム -->
                    <div class="upload-section">
                        <div class="text-center mb-4">
                            <div class="upload-icon">
                                <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                            </div>
                            <h5 class="mt-3">PDFを選択して変換</h5>
                            <p class="text-muted">決まった様式のPDFファイルを選択すると自動で変換が開始されます</p>
                        </div>

                        <!-- 通常のアップロード・変換フォーム -->
                        <form method="post" enctype="multipart/form-data" id="uploadForm">
                            {% csrf_token %}
                            <div class="mb-3">
                                <div class="file-upload-wrapper">
                                    <input type="file" class="form-control" id="id_pdf_file" name="pdf_file" accept=".pdf" required>
                                    <label for="id_pdf_file" class="file-label">
                                        <i class="bi bi-file-earmark-pdf"></i> PDFファイルを選択して変換開始
                                    </label>
                                </div>
                                {% if form.pdf_file.errors %}
                                    <div class="text-danger mt-2">
                                        {% for error in form.pdf_file.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="d-grid" id="submitButtonArea">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" style="display: none;">
                                    <i class="bi bi-arrow-repeat"></i> 変換実行
                                </button>
                            </div>
                        </form>

                        <!-- 手動操作用のボタン（JavaScriptが無効な場合のフォールバック） -->
                        <noscript>
                            <div class="alert alert-warning mt-3">
                                <small>JavaScriptが無効です。ファイルを選択後、変換ボタンを押してください。</small>
                            </div>
                        </noscript>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- 注意事項 -->
        <div class="alert alert-warning mt-4">
            <h6><i class="bi bi-exclamation-triangle"></i> 重要な注意事項</h6>
            <ul class="mb-0">
                <li>決まった様式でなければ正確に読み取りできません</li>
                <li>ファイルサイズは10MB以下にしてください</li>
                <li>処理には数分かかる場合があります</li>
            </ul>
        </div>

        <div class="text-center mt-3">
            <a href="{% url 'B_ocr:format_info' %}" class="btn btn-outline-primary">
                <i class="bi bi-info-circle"></i> 読み取るにはこちらの様式を使用する必要があります
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_pdf_file');
    const form = document.getElementById('uploadForm');

    // 処理中の場合は進捗監視を開始
    {% if processing and session_id %}
    const sessionId = '{{ session_id }}';
    console.log('処理中のセッションID:', sessionId);
    startProgressMonitoring(sessionId);
    {% endif %}

    // ファイル選択時の処理
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // ファイルサイズチェック (10MB = 10 * 1024 * 1024 bytes)
                if (file.size > 10 * 1024 * 1024) {
                    alert('ファイルサイズは10MB以下にしてください。');
                    fileInput.value = '';
                    return;
                }

                // PDFファイルかチェック
                if (file.type !== 'application/pdf') {
                    alert('PDFファイルを選択してください。');
                    fileInput.value = '';
                    return;
                }

                // 確認ダイアログ
                if (confirm(`「${file.name}」を変換しますか？\n処理には数分かかる場合があります。`)) {
                    // フォーム送信
                    form.submit();
                } else {
                    // キャンセルされた場合はファイル選択をリセット
                    fileInput.value = '';
                }
            }
        });
    }

    // フォーム送信前の処理
    if (form) {
        form.addEventListener('submit', function(e) {
            // ファイルが選択されていない場合の手動送信を防ぐ
            if (!fileInput.files[0]) {
                e.preventDefault();
                alert('PDFファイルを選択してください。');
            }
        });
    }
});

function startProgressMonitoring(sessionId) {
    const currentPageElement = document.getElementById('currentPage');
    const totalPagesElement = document.getElementById('totalPages');
    const statusMessageElement = document.getElementById('statusMessage');
    const completedSection = document.getElementById('completedSection');
    const errorSection = document.getElementById('errorSection');
    const errorMessage = document.getElementById('errorMessage');
    const processingSection = document.querySelector('.processing-section');

    let retryCount = 0;
    const maxRetries = 5;

    function updateProgress() {
        console.log(`進捗チェック中... セッションID: ${sessionId}`);
        
        fetch(`/progress/${sessionId}/`)
            .then(response => {
                console.log('API応答ステータス:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('進捗データ:', data);
                retryCount = 0; // 成功したらリトライカウントをリセット

                // 進捗更新
                if (currentPageElement) currentPageElement.textContent = Math.floor(data.current) || 0;
                if (totalPagesElement) totalPagesElement.textContent = Math.floor(data.total) || 1;
                if (statusMessageElement) statusMessageElement.textContent = data.message || '';

                if (data.status === 'completed') {
                    console.log('処理完了！結果ファイル:', data.result_file);
                    
                    // 完了時の処理
                    if (completedSection) {
                        completedSection.style.display = 'block';
                        document.querySelector('.progress-info').style.display = 'none';
                        document.querySelector('.spinner-border').style.display = 'none';
                    }
                    
                    // 2秒後に完了画面にリダイレクト
                    setTimeout(() => {
                        let redirectUrl = '{% url "B_ocr:upload" %}?completed=true';
                        if (data.result_file) {
                            redirectUrl += '&file=' + encodeURIComponent(data.result_file);
                        }
                        console.log('リダイレクト先:', redirectUrl);
                        window.location.href = redirectUrl;
                    }, 2000);
                    
                } else if (data.status === 'error') {
                    console.log('処理エラー:', data.message);
                    
                    // エラー時の処理
                    if (errorSection && errorMessage) {
                        errorMessage.textContent = data.message || 'エラーが発生しました';
                        errorSection.style.display = 'block';
                        document.querySelector('.progress-info').style.display = 'none';
                        document.querySelector('.spinner-border').style.display = 'none';
                    }
                    
                } else {
                    // 処理中の場合は継続監視
                    console.log('処理継続中...');
                    setTimeout(updateProgress, 2000); // 2秒間隔で更新
                }
            })
            .catch(error => {
                console.error('進捗監視エラー:', error);
                retryCount++;
                
                if (retryCount < maxRetries) {
                    console.log(`リトライ ${retryCount}/${maxRetries}`);
                    setTimeout(updateProgress, 5000); // エラー時は5秒後に再試行
                } else {
                    console.error('最大リトライ数に達しました');
                    if (errorSection && errorMessage) {
                        errorMessage.textContent = '通信エラーが発生しました。ページを更新してください。';
                        errorSection.style.display = 'block';
                        document.querySelector('.progress-info').style.display = 'none';
                        document.querySelector('.spinner-border').style.display = 'none';
                    }
                }
            });
    }

    // 初回実行
    updateProgress();
}
</script>

<style>
.file-upload-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
}

.file-upload-wrapper input[type=file] {
    position: absolute;
    left: -9999px;
    opacity: 0;
}

.file-label {
    display: block;
    padding: 12px 24px;
    cursor: pointer;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    text-align: center;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
}

.file-label:hover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.file-upload-wrapper input[type=file]:focus + .file-label {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.processing-section {
    padding: 2rem 0;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.progress-info {
    margin: 1rem 0;
}

.progress-info .alert {
    margin-bottom: 0;
}

#progressText {
    font-size: 1.1rem;
}

#statusMessage {
    font-size: 0.9rem;
}

.success-section {
    padding: 2rem 0;
}

</style>
{% endblock %}